version: '2'

services:
  kong-adapter-test-data:
    env_file: variables.env  
    build: 
      context: portal-kong-adapter
    volumes:
    - "/var/portal-api/static"

  portal-api:
    env_file: variables.env  
    image: ${DOCKER_PREFIX}portal-api:${DOCKER_TAG}${BUILD_ALPINE}
    volumes_from:
    - "kong-adapter-test-data"
    environment:
    - "PORTAL_API_HOOK_INTERVAL=200"

  portal-kong-adapter:
    env_file: variables.env
    image: ${DOCKER_PREFIX}portal-kong-adapter:${DOCKER_TAG}${BUILD_ALPINE}
    depends_on:
    - portal-api
    - kong
  
  kong-database:
    image: postgres:9.6
    environment:
    - "POSTGRES_USER=kong"
    - "POSTGRES_PASSWORD=kong"

  kong:
    image: ${DOCKER_PREFIX}kong:${DOCKER_TAG}
    depends_on:
    - "kong-database"
    links:
    - kong-database:kong-database
    security_opt:
    - seccomp:unconfined

networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 10.222.222.0/24
        gateway: 10.222.222.1
